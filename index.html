<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Penniless ‚Äì Global 5s Tap Challenge</title>
<style>
  :root{ --bg:#0b1020; --card:#141a31; --ink:#e5e7eb; --muted:#9aa3b2; --accent:#f59e0b; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,Segoe UI,Inter,Roboto,Arial;
    background:radial-gradient(1200px 600px at 20% -10%, #1b2240 0%, transparent 60%),
               radial-gradient(1200px 600px at 120% 110%, #1b2240 0%, transparent 60%), var(--bg);
    color:var(--ink);display:grid;grid-template-columns:1fr 360px;gap:18px;padding:18px}
  header{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;gap:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand h1{margin:0;font-size:clamp(20px,2.5vw,28px)}
  .user{display:flex;gap:10px;align-items:center;color:var(--muted)}
  .btn{border:0;background:linear-gradient(180deg,#fdbb2d,#f59e0b);color:#1a1304;font-weight:700;
    padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 20px rgba(245,158,11,.25)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  main{background:var(--card);border:1px solid #232b4d;border-radius:18px;padding:22px;
    display:grid;place-items:center;position:relative;min-height:72vh}
  .penny-wrap{user-select:none;display:grid;place-items:center;border-radius:999px;padding:12px;transition:transform .06s}
  .penny{width:min(70vmin,520px);max-width:520px;aspect-ratio:1/1;border-radius:50%;background:#3a2a12;
    display:grid;place-items:center;position:relative;box-shadow:inset 0 0 0 12px #2a1c07, inset 0 0 0 24px #1d1305, 0 30px 60px rgba(0,0,0,.45)}
  .penny img{width:90%;height:90%;object-fit:contain;border-radius:50%;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));pointer-events:none}
  .stats{position:absolute;top:18px;left:18px;right:18px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;font-weight:700}
  .chip{background:#0f1530;border:1px solid #222b57;color:#cbd5e1;padding:8px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;min-width:120px;justify-content:center}
  .chip b{color:#fff}
  .tap-hint{position:absolute;bottom:18px;text-align:center;color:var(--muted)}
  aside{background:var(--card);border:1px solid #232b4d;border-radius:18px;padding:18px;display:flex;flex-direction:column;gap:14px;min-height:72vh;position:sticky;top:18px}
  h2{margin:0 0 6px 0;font-size:18px}
  ol{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
  li{background:#0f1530;border:1px solid #222b57;border-radius:12px;padding:10px 12px;display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center}
  .rank{background:#1c2449;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;color:#dbe2ff;font-weight:800}
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .score{font-weight:800}
  .me{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(245,158,11,.18) inset}
  .controls{display:flex;gap:8px}
  .reset{background:#102b38;color:#93c5fd;border:1px solid #244a5e}
  .ghost{background:#0f1530;border:1px dashed #33406d;color:#9aa3b2}
  .modal{position:fixed;inset:0;background:rgba(4,8,20,.72);display:grid;place-items:center;padding:18px}
  .dialog{background:#111737;border:1px solid #2b3566;border-radius:16px;padding:20px;width:min(460px,92vw);display:flex;flex-direction:column;gap:12px}
  .dialog h3{margin:0}
  .field{display:flex;flex-direction:column;gap:6px}
  input[type="text"]{background:#0b112d;border:1px solid #263165;color:#e5e7eb;padding:12px 14px;border-radius:12px;outline:none}
  .hidden{display:none!important}
  @media (max-width:980px){body{grid-template-columns:1fr;padding-bottom:90px}aside{position:static;order:3}}

  /* Tabs */
  .tabs{display:flex;gap:8px;align-items:center}
  .tab{background:#0f1530;color:#cbd5e1;border:1px solid #33406d;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(180deg,#fdbb2d,#f59e0b);color:#1a1304;border-color:#f59e0b}

  /* Roadmap styles */
  .roadmap{background:var(--card);border:1px solid #232b4d;border-radius:18px;padding:22px;min-height:72vh;display:flex;flex-direction:column;gap:14px}
  .rm-hero{display:flex;gap:14px;align-items:center}
  .rm-badge{display:inline-flex;gap:8px;align-items:center;background:#0f1530;border:1px solid #33406d;padding:8px 12px;border-radius:999px;font-weight:800}
  .rm-list{display:grid;gap:10px;margin-top:6px}
  .rm-item{background:#0f1530;border:1px solid #222b57;border-radius:12px;padding:12px 14px}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#f59e0b" stroke-width="2"/><circle cx="12" cy="12" r="7" stroke="#f59e0b" stroke-width="2"/></svg>
      <h1>Penniless ‚Ä¢ 5s Tap Challenge (Global)</h1>
    </div>
    <div class="tabs" role="tablist" aria-label="Sections">
      <button id="tabPlay" class="tab" role="tab" aria-controls="sectionPlay" aria-selected="false">Play</button>
      <button id="tabRoadmap" class="tab active" role="tab" aria-controls="sectionRoadmap" aria-selected="true">Roadmap</button>
    </div>
    <div class="user">
      <span id="welcome">Not signed in</span>
      <button id="changeUser" class="btn ghost">Change user</button>
    </div>
  </header>

  <!-- PLAY VIEW -->
  <main id="sectionPlay" data-tab="play" class="hidden" role="tabpanel" aria-labelledby="tabPlay">
    <div class="stats">
      <div class="chip">Time: <b id="time">5.00</b>s</div>
      <div class="chip">Taps: <b id="taps">0</b></div>
      <div class="chip">Best (you): <b id="best">0</b></div>
    </div>
    <div class="penny-wrap" id="pennyWrap">
      <div id="penny" class="penny" role="button" aria-label="Tap the penny!" tabindex="0">
        <img src="penny.png" alt="Penniless coin">
      </div>
    </div>
    <div class="tap-hint">Tap the penny. Timer starts on first tap. Submit to post globally.</div>
    <div class="controls" style="position:absolute; top:18px; right:18px">
      <button id="restart" class="btn reset" disabled>Restart</button>
      <button id="submit" class="btn" disabled>Submit score</button>
    </div>
  </main>

  <aside id="asidePlay" data-tab="play" class="hidden" aria-hidden="true">
    <h2>üèÜ Global Leaderboard (Top 10)</h2>
    <div class="chip" id="liveMode" aria-live="polite" style="justify-content:flex-start;min-width:auto;width:max-content">Live: ‚Ä¶</div>
    <ol id="board"></ol>
    <small style="color:var(--muted)">Live updates via Supabase Realtime when available; otherwise auto‚Äërefresh polling.</small>
  </aside>

  <!-- ROADMAP VIEW -->
  <section id="sectionRoadmap" data-tab="roadmap" class="roadmap" role="tabpanel" aria-labelledby="tabRoadmap">
    <div class="rm-hero">
      <span class="rm-badge">üó∫Ô∏è Roadmap</span>
      <span style="color:var(--muted)">What we're building & how rewards work</span>
    </div>

    <div class="rm-item" style="border-color:#f59e0b">
      <strong>üéÅ Solana Giveaways ‚Äî Every 30 Minutes</strong>
      <p style="margin:.4rem 0 0; color:#cbd5e1">
        We will give away <strong>SOL</strong> from the <em>global fees</em> to the <strong>top 3</strong> players on the Global Leaderboard <strong>every 30 minutes</strong>.
        Keep tapping, climb the board, and watch for the payout windows.
      </p>
    </div>

    <div class="rm-list">
      <div class="rm-item">
        <strong>Phase 1 ‚Äî Global 5s Tap</strong>
        <p style="margin:.4rem 0 0; color:#cbd5e1">Core game, public leaderboard, and real-time updates via Supabase.</p>
      </div>
      <div class="rm-item">
        <strong>Phase 2 ‚Äî Anti-cheat & Verified Accounts</strong>
        <p style="margin:.4rem 0 0; color:#cbd5e1">Device checks, rate limiting, and optional wallet verification.</p>
      </div>
      <div class="rm-item">
        <strong>Phase 3 ‚Äî On-chain Rewards</strong>
        <p style="margin:.4rem 0 0; color:#cbd5e1">Automated SOL distribution sourced from global fees.</p>
      </div>
    </div>

    <p class="rm-item" style="opacity:.85">
      <small>Note: The giveaways are promotional and may change as the project evolves. Final eligibility and details will be announced in-app and on socials.</small>
    </p>
  </section>

  <!-- Login modal -->
  <div id="modal" class="modal">
    <div class="dialog">
      <h3>Sign in to play</h3>
      <div class="field">
        <label for="username">Username</label>
        <input id="username" type="text" minlength="2" maxlength="20" placeholder="e.g., antonis" autocomplete="nickname" />
      </div>
      <button id="login" class="btn">Continue</button>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (() => {
    const SUPABASE_URL = "https://lgqggbdevlqmvrgnwljy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxncWdnYmRldmxxbXZyZ253bGp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NzAxNzQsImV4cCI6MjA3NDA0NjE3NH0.s3q6Ggb3hmrelVmUG4tQVIe_Luft3S4QYTsRu0tF-NU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const timeEl=document.getElementById('time'), tapsEl=document.getElementById('taps'), bestEl=document.getElementById('best'), boardEl=document.getElementById('board');
    const penny=document.getElementById('penny'), pennyWrap=document.getElementById('pennyWrap'), restartBtn=document.getElementById('restart'), submitBtn=document.getElementById('submit');
    const modal=document.getElementById('modal'), loginBtn=document.getElementById('login'), unameInput=document.getElementById('username'), changeUserBtn=document.getElementById('changeUser'), welcome=document.getElementById('welcome');
    const tabPlay=document.getElementById('tabPlay'), tabRoadmap=document.getElementById('tabRoadmap');
    const sectionPlay=document.getElementById('sectionPlay'), asidePlay=document.getElementById('asidePlay'), sectionRoadmap=document.getElementById('sectionRoadmap');
    const liveMode=document.getElementById('liveMode');

    const LS_USER='penniless_user', LS_BESTS='penniless_bests', LS_MOCK='penniless_mock_board';

    const getUser=()=>localStorage.getItem(LS_USER);
    const setUser=(u)=>localStorage.setItem(LS_USER,u);
    const getBests=()=>JSON.parse(localStorage.getItem(LS_BESTS)||'{}');
    const setBestFor=(u,s)=>{const b=getBests(); b[u]=Math.max(s,b[u]||0); localStorage.setItem(LS_BESTS,JSON.stringify(b));};
    const getBestFor=(u)=>(getBests()[u]||0);

    // --- Mock leaderboard helpers (fallback when network/WebSocket not available) ---
    function getMockBoard(){
      const raw = JSON.parse(localStorage.getItem(LS_MOCK) || '[]');
      return raw.sort((a,b)=> (b.best||0)-(a.best||0)).slice(0,10);
    }
    function saveMockScore(username, score){
      const board = JSON.parse(localStorage.getItem(LS_MOCK) || '[]');
      const idx = board.findIndex(x=>x.username===username);
      if(idx>-1){ board[idx].best = Math.max(board[idx].best||0, score); }
      else{ board.push({username, best: score}); }
      localStorage.setItem(LS_MOCK, JSON.stringify(board));
    }

    // --- Rendering ---
    function renderBoard(data, highlight){
      boardEl.innerHTML='';
      (data||[]).forEach((e,i)=>{
        const li=document.createElement('li');
        if(highlight && e.username===highlight) li.classList.add('me');
        li.innerHTML=`<div class="rank">${i+1}</div><div class="name">${e.username}</div><div class="score">${e.best}</div>`;
        boardEl.appendChild(li);
      });
    }

    // --- Data fetch with graceful fallback ---
    async function fetchBoard(highlight){
      try{
        const { data, error } = await supabase
          .from('scores')
          .select('username,best')
          .order('best',{ascending:false})
          .limit(10);
        if(error) throw error;
        renderBoard(data, highlight);
        return true;
      }catch(err){
        console.warn('[board] Using mock fallback:', err?.message||err);
        renderBoard(getMockBoard(), highlight);
        return false;
      }
    }

    async function postBest(u,s){
      try{
        await supabase.rpc('set_best',{p_username:u,p_score:s});
      }catch(err){
        console.warn('[postBest] Offline/mock fallback:', err?.message||err);
        saveMockScore(u,s);
      }
    }

    function setLive(mode){
      if(!liveMode) return;
      liveMode.textContent = mode==='realtime' ? 'Live: Realtime' : 'Live: Polling';
    }

    let pollHandle=null;
    async function startPolling(){
      clearInterval(pollHandle);
      setLive('polling');
      await fetchBoard(getUser());
      pollHandle = setInterval(()=>fetchBoard(getUser()), 15000);
    }

    function stopPolling(){ if(pollHandle){ clearInterval(pollHandle); pollHandle=null; } }

    function canUseRealtime(){
      // WebSocket must exist and not be intentionally disabled by the environment
      return typeof WebSocket !== 'undefined';
    }

    function startRealtime(){
      try{
        const channel = supabase.channel('scores-changes');
        channel.on('postgres_changes',{event:'*',schema:'public',table:'scores'},()=>fetchBoard(getUser()));
        channel.subscribe((status)=>{
          if(status==='SUBSCRIBED'){
            stopPolling();
            setLive('realtime');
          }
        });
        window.addEventListener('beforeunload',()=>{ try{ channel.unsubscribe(); }catch(_){} });
      }catch(err){
        console.warn('[realtime] Disabled, falling back to polling:', err?.message||err);
        startPolling();
      }
    }

    // --- Game logic ---
    let playing=false, finished=false, taps=0, startTS=null;
    const GAME_MS=5000;
    const fmt=(ms)=> (Math.max(0,ms)/1000).toFixed(2);
    function reset(){playing=false;finished=false;taps=0;startTS=null;tapsEl.textContent='0';timeEl.textContent=fmt(GAME_MS);restartBtn.disabled=true;submitBtn.disabled=true;}
    function setWelcome(u){welcome.textContent=u?`Signed in as ${u}`:'Not signed in';}

    function ensureUser(){
      const u=getUser();
      if(u){
        modal.classList.add('hidden');
        setWelcome(u);
        bestEl.textContent=getBestFor(u);
        fetchBoard(u);
      }else{
        modal.classList.remove('hidden');
        unameInput.focus();
      }
    }

    function tick(){
      if(!playing) return;
      const left=Math.max(0,GAME_MS-(performance.now()-startTS));
      timeEl.textContent=fmt(left);
      if(left<=0){ playing=false; finished=true; restartBtn.disabled=false; submitBtn.disabled=false; return; }
      requestAnimationFrame(tick);
    }

    ['pointerdown','keydown'].forEach(evt=>{
      penny.addEventListener(evt,e=>{
        if(evt==='keydown'&&!(e.key===' '||e.key==='Enter')) return;
        e.preventDefault();
        const u=getUser();
        if(!u){ modal.classList.remove('hidden'); return; }
        if(!playing&&!finished){ playing=true; startTS=performance.now(); requestAnimationFrame(tick); }
        if(!playing) return;
        taps++; tapsEl.textContent=String(taps);
        pennyWrap.style.transform='scale(0.97)'; setTimeout(()=>pennyWrap.style.transform='scale(1)',50);
      },{passive:false});
    });

    restartBtn.addEventListener('click',reset);
    submitBtn.addEventListener('click',async()=>{
      if(!finished) return;
      const u=getUser(); if(!u) return;
      setBestFor(u,taps); bestEl.textContent=getBestFor(u);
      submitBtn.disabled=true;
      await postBest(u,taps);
      fetchBoard(u);
    });

    loginBtn.addEventListener('click',()=>{
      const v=unameInput.value.trim().slice(0,20);
      if(v.length<2){ unameInput.focus(); return; }
      setUser(v);
      modal.classList.add('hidden');
      setWelcome(v);
      bestEl.textContent=getBestFor(v);
      fetchBoard(v);
    });

    changeUserBtn.addEventListener('click',()=>{ modal.classList.remove('hidden'); unameInput.value=''; unameInput.focus(); });

    // Tabs logic
    function showTab(name){
      const isPlay = name==='play';
      [sectionPlay, asidePlay].forEach(el=>el.classList.toggle('hidden', !isPlay));
      sectionPlay.setAttribute('aria-hidden', (!isPlay).toString());
      asidePlay.setAttribute('aria-hidden', (!isPlay).toString());
      sectionRoadmap.classList.toggle('hidden', isPlay);
      tabPlay.classList.toggle('active', isPlay); tabPlay.setAttribute('aria-selected', isPlay.toString());
      tabRoadmap.classList.toggle('active', !isPlay); tabRoadmap.setAttribute('aria-selected', (!isPlay).toString());
      if(isPlay) fetchBoard(getUser());
    }
    tabPlay.addEventListener('click',()=>showTab('play'));
    tabRoadmap.addEventListener('click',()=>showTab('roadmap'));

    // --- Init ---
    reset(); ensureUser(); showTab('roadmap');
    if(canUseRealtime()) startRealtime(); else startPolling();

    // --- Minimal self-tests (console) ---
    (function runTests(){
      function assert(name, cond){ console[(cond?'log':'error')]( (cond?'‚úÖ':'‚ùå')+' '+name ); }
      // Test 1: time formatter
      assert('fmt(5000) -> "5.00"', fmt(5000)==='5.00');
      // Test 2: best score storage keeps max
      const tmpUser='__test_user__'; setBestFor(tmpUser, 5); setBestFor(tmpUser, 3); assert('best stays at max', getBestFor(tmpUser)===5);
      // Test 3: mock board sort desc
      saveMockScore('__a__', 10); saveMockScore('__b__', 20); const m=getMockBoard(); assert('mock sorted desc', m.length && m[0].best>=m[m.length-1].best);
      // Test 4: tabs ARIA sync
      showTab('play'); const ariaOk = sectionPlay.getAttribute('aria-hidden')==='false' && asidePlay.getAttribute('aria-hidden')==='false' && tabPlay.getAttribute('aria-selected')==='true';
      assert('tabs aria sync', ariaOk);
      // Cleanup test artefacts
      const b=getBests(); delete b[tmpUser]; localStorage.setItem(LS_BESTS, JSON.stringify(b));
    })();
  })();
  </script>
</body>
</html>
